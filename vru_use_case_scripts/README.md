# VRU use-case scripts

This directory contains scripts to help with data analysis for VRU use-cases.

## `extract_rtf_data`

This script takes in a Docker container log output and extracts realtime factor (RTF) data, outputting the results as
comma-separated values (CSV) with the following format:

```text
<sim_time_nanoseconds>,<rtf_value>
<sim_time_nanoseconds>,<rtf_value>
...
<sim_time_nanoseconds>,<rtf_value>
```

### Usage examples

Output the CSV data directly to the terminal:

```console
docker logs carma-simulation 2>&1 | ./extract_rtf_data
```

Output the CSV data to a file:

```console
docker logs carma-simulation 2>&1 | ./extract_rtf_data > rtf_data.csv
```

Pipe the CSV data into the `plot_rtf_data` script (see below):

```console
docker logs carma-simulation 2>&1 | ./extract_rtf_data | ./plot_rtf_data
```

## `plot_rtf_data`

This script takes in CSV-formatted RTF data from standard input or a file and plots the results. This script
has an optional `--min-required` argument that will plot a horizontal line at the level specified.

### Usage examples

Plot the RTF data from a file:

```console
./plot_rtf_data rtf_data.csv
```

```console
./plot_rtf_data --min-required 0.50 rtf_data.csv
```

Plot the RTF data from standard input (_e.g._, through a pipe):

```console
docker logs carma-simulation 2>&1 | ./extract_rtf_data | ./plot_rtf_data
```

```console
docker logs carma-simulation 2>&1 | ./extract_rtf_data | ./plot_rtf_data --min-required 0.35
```

## `plot_sdsm_position_error`

This script takes in two CSV files containing detected object and SDSM reports generated from V2XHub logs. It plots the
position difference between entries in the two files. For each detected object and for each timestamp, the script
searches in the SDSM CSV file for a corresponding entry. It then calculates the distance between the two entires.
Finally, the script plots the results for each object for the duration of the simulation.

> [!NOTE]
> This script relies on the CSV files generated by the `parse_kafka_logs.py` script.

### Usage examples

Plot the data:

```console
./plot_sdsm_position_error \
  --sdsm-csv <path_to_csv_dir>/sdsm.csv \
  --detection-csv <path_to_csv_dir>/detected_object.csv
```

### Example output

![](docs/example_plot.png)

## `plot_detected_objects`

This script takes in data about vehicle-detected and SDSM-reported objects. It then plots
their positions along with the error between what the vehicle detected and what the SDSMs
reported.

> [!NOTE]
> This script relies on the CSV files generated by the `parse_kafka_logs.py` script.

### Usage examples

Plot the data:

```console
./plot_detected_objects \
  --sdsm-csv <path_to_csv_dir>/sdsm.csv \
  --vehicle-detection-csv <path_to_csv_dir>/vehicle_detected_objects.csv \
  --infrastructure-sensors-json <path_to_sensor_config>/sensors.json
```

### Example output

![](docs/plot_detected_objects_example.png)

## `plot_time_to_collision`

This script takes in two CSV files containing vehicle and pedestrian odometry generated from rosbags.
For each vehicle odometry point, the script propagates the vehicle forward along the path while keeping
the vehicle's longitudinal velocity fixed. While propagating the vehicle forward, the script checks
for collisions with the pedestrian. If there is a collision, the script uses the elapsed traversal
time as the time to collision (TTC).

> [!NOTE]
> This script assumes the vehicle and pedestrian are point masses, and the `COLLISION_THRESHOLD_M` variable determines
> when a collision occurs.

> [!NOTE]
> When running this script on data generated from CDASim, the vehicle's odometry positions are its center mass, not
> the rear axle.

> [!NOTE]
> This script relies on the CSV files generated by the `parse_kafka_logs.py` script.

### Usage examples

Plot the data:
```console
./plot_time_to_collision \
  --vehicle-odometry-csv <path_to_csv_dir>/vehicle_odometry.csv \
  --pedestrian-odometry-csv <path_to_csv_dir>/pedestrian_odometry.csv
```


### Example output

![](docs/plot_time_to_collision_example.png)

## `monitor_time_sync_through_logs`

This script monitors whether if all components are stepping in synchronization ensuring their simulation time synchronization.

```console
./monitor_time_sync_through_logs
```

### Example output
Red line shows how long in system wall time it took for MOSAIC to step to the next simulation time step.
Blue lines show how long it took ofr each tool to be called by MOSAIC to step to the next simulation time step.
We should expect red lines under the blue so that all tools are moving forward at the same time.
First subplot on the top indicates whether of all tools are synced or not according to above criteria where 1:Synced 0: Not.
MOSAIC.log is mosaic time
vx2hub.log is V2XHub time
Traffic.log is sumo and carla time (since they are synced)
rosout.log is ROS time
![](docs/time_sync_plot_example.png)
